name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-installer:
    name: Build Windows Installer
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          pip install -r agent/requirements.txt pyinstaller

      - name: Write VERSION from tag
        run: |
          Set-Content -Path agent/VERSION -Value $env:GITHUB_REF_NAME -NoNewline

      - name: Build agent with PyInstaller
        run: |
          cd agent
          pyinstaller pyinstaller.spec

      - name: Prepare NSSM
        run: |
          $nssmLocal = "agent/nssm-2.24/win64/nssm.exe"
          $nssmDest = "agent/installer/nssm/nssm.exe"
          $nssmDir = "agent/installer/nssm"
          New-Item -ItemType Directory -Path $nssmDir -Force | Out-Null
          if (Test-Path $nssmLocal) {
            Copy-Item -Path $nssmLocal -Destination $nssmDest -Force
            Write-Host "Using NSSM from repository."
            exit 0
          }
          $nssmUrl = "https://nssm.cc/release/nssm-2.24.zip"
          $nssmZip = "$env:RUNNER_TEMP\nssm.zip"
          $maxAttempts = 3
          $delaySeconds = 10
          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
            try {
              Write-Host "Download attempt $attempt of $maxAttempts..."
              Invoke-WebRequest -Uri $nssmUrl -OutFile $nssmZip -UseBasicParsing
              Expand-Archive -Path $nssmZip -DestinationPath $env:RUNNER_TEMP -Force
              Copy-Item "$env:RUNNER_TEMP\nssm-2.24\win64\nssm.exe" -Destination $nssmDest -Force
              Write-Host "NSSM downloaded and extracted successfully."
              exit 0
            } catch {
              Write-Host "Attempt $attempt failed: $_"
              if ($attempt -lt $maxAttempts) {
                Write-Host "Waiting $delaySeconds seconds before retry..."
                Start-Sleep -Seconds $delaySeconds
              } else {
                throw "Failed to download NSSM after $maxAttempts attempts."
              }
            }
          }

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build installer with Inno Setup
        run: |
          iscc /DVersion=${{ github.ref_name }} agent/installer/iflab-agent.iss

      - name: Prepare release assets
        run: |
          New-Item -ItemType Directory -Path release-assets -Force
          Copy-Item -Path agent/dist/iflab-agent-setup-*.exe -Destination release-assets/

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: release-assets/

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-installer
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: windows-installer/**/*.exe
